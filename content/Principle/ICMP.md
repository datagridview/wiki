---
title: "ICMP"
date: 2017-11-03 18:13
updated: 2017-11-03 18：13
tag: Principle
collection: TCP/IP
log: "ICMP原理解释"
---

[TOC]

## ICMP：Internet控制报文协议

ICMP被认为是IP的一部分，因为它使用IP来传输，在五层网络协议中介于运输层和网络层之间。

不是为了确保IP的可靠性，而是表示故障信息。容易被黑客利用影响系统功能操作和获取配置信息。

#### 封装

* 在IP中被封装。IPv4中协议字段为1，表示携带ICMPv4。
* ICMPv4类型字段保留了42个不同的值，只有8个经常使用。
* ICMP头部中包含用于计算校验和的位数。

### ICMP报文

#### 种类

* 差错报文(error Message)
* 信息报文(info Message)

#### ICMPv4

信息报文分为：回显请求（类型8），回显应答（类型0），路由器通告（类型9），路由器请求（类型10）。

差错报文分为：目的地不可达（类型3），重定向（类型5），超时（类型11），参数问题（类型12）

#### ICMPv6

简略。了解0-127都是差错报文，128-255都是信息报文。目的不可达为类型1。

### ICMP差错报文

为限制产生广播风暴，对生成ICMP有一定限制。

* 对于以下情况不会响应产生ICMPv4差错报文：
  * v4差错报文
  * 目的地是广播或组播地址的数据报
  * 链路层广播的数据报
  * 不是第一个分片的其它分片
  * 源地址不能为环回地址，零地址，广播组播地址。
* 对于以下情况不会响应产生ICMPv6差错报文：
  * v6差错报文
  * v6重定向报文
  * 目的地为组播地址
  * 链路层组播、广播地址

令牌桶由（B,N）构造最大数量B，增长速率N，单位是字节。由于限制单一发送者。

#### 目标不可达

数据包无法发送到目的地。

当出现差错的时候会返回差错报文包含IP头部+ICMP头部+违规数据包（TCP|UDP或者别的什么的原始数据报）

v4包含16个不同的代码表示类型，4个常用。

* 主机不可达（1）
* 端口不可达（3）
* 需要分片|已指定不用分片（4）
* 管理禁止通信（13）

v6包含7个不同的代码。

* 地址不可达
* 目的无路由
* 管理禁止通信
* 端口不可达
* 数据包太大
* 超出源地址范围
* 拒绝路由到目的地（黑洞路由）不希望被发送到的地址（火星路由、虚假路由）

#### 重定向

投递数据报到下一跳。因为确定给定的数据报存在一个比自己更好的下一跳路由，发送重定向报文使其更新转发表，同时把数据报转发给更好的路由。

#### ICMP超时